## 1. Тема и целевая аудитория

hh.ru — российский сервис по поиску работы и найму

Аудитория:
- MAU 33,8M [^1]
- WAU 9,4M [^1]
- DAU 2,1M [^1]

Распределение по странам [^2]:
1. Россия - 91,96%
2. Беларусь - 2,13%
3. Германия - 0,82%
4. Армения - 0,56%
5. Нидерланды - 0,55%

* Ключевой функционал - просмотр открытых вакансий и публикация новых вакансий

* Ключевое продуктовое решение - возможность отклика на вакансию и связаться с работодателем через платформу

Выделен следующий функционал MVP:
- Авторизация
- Поиск (по ключевым словам в вакансии, категориям)
- Просмотр вакансий
- Публикация вакансий
- Отклик на вакансии с последующей возможностью связаться во внутреннем чате
- Создание резюме по шаблону
- LLM модель, отсеивающая со стороны рекрутера "спам-отклики", чтобы максимизировать общее качество всех откликов

## 2. Расчет нагрузки

Анализ трафика:

- 54 млн пользователей [^3]
- 18 млн зарегистрированных пользователей ежемесячно [^4]
- 2276 тыс проверенных компаний [^4]
- 88 млн резюме в базе [^4]
- 13 964 601 активных резюме [^6]
- 1217 тыс вакансий [^4]


Действия пользователя:

| Действие                    | Кол-во в день | Обоснование |
|-----------------------------|---------------|-------------|
| Авторизация                 | 0,03 | Допустим, что токен авторизации живет месяц. Следовательно, для одного пользователя регистрация будет производиться 1/30 = 0,03 раз|
| Регистрация                 | 0,00005 | В сервисе-аналоге linkedin прирост пользователей с 2023 по 2024 год составлял 1,1М[^13]. Из соотношения 58,6М (DAU linkedin[^11]) / 2,1M (DAU hh.ru) = 1,1M / x => x = 0,018 * 2,1M пользователя в год => 0,00005 один пользователь делает регистраций в день | 
| Просмотр вакансий           | 44 | В сервисе-аналоге linkedin каждую минуту просматривается 1,8М объявлений[^10] -> 2592M объявлений просматривается в день. Из соотношения 58,6М (DAU linkedin[^11]) / 2,1M (DAU hh.ru) = 2592M / x => x = 44 * 2,1M просмотра в день => 44 объявления просматривает один пользователь в день | 
| Поиск вакансий              | 13 | 30% пользователей пользуется поисковой строкой, если она есть на сайте[^12], поэтому берем значение просмотра вакансий и умножаем на 0,3 и получаем 44 * 0,3 = 13,2|
| Публикация вакансий         | 0,001 | В linkedin 30М+ вакансий публикуется в год[^8] => 83000 вакансии в день. Из тех же пропорций получаем, что в день одним пользователем на hh.ru публикуется 0,001 вакансия|
| Закрытие вакансий           | 0,0001 | Считаем, что закрытие вакансии = 1 человек нашёл работу. В linkedin происходит 4,2M найма в год, т. е. 11666 закрытых вакансий в день[^15]. По соотношению в hh.ru одним человеком закрывается 0,0001 вакансий в день|
| Отклик на вакансию          | 0,2 | В сервисе-аналоге linkedin каждую минуту совершается 9,5 тыс откликов[^10] -> 13,68M откликов в день. DAU в linkedin составляет 58,6М[^11]. Составляем такое же уравнение и получаем, что в hh.ru совершается 490238 откликов в день. Делим на DAU и получаем 0,2 отклика в день от одного пользователя| 
| Ответ на отклик на вакансию | 0,2 | Количество ответов на отклики будем считать равными количеству откликов| 
| Использование чата          | 1,7 | В linkedin отправляется более 100М сообщений в день[^8] => из тех же пропорций 1,7 сообщений отправляется одним пользователем в hh.ru в день| 
| Создание и обновление резюме| 0,00013 | Будем считать, что 90% зарегистрировавшихся пользователей воспользуются этой функцией + считаем, что каждый пользователь 2 раза в год обновляет свое резюме[^19]. Из рассчетов действий регистрации (0,018 * 2,1M) * 0,9 * 3 (1 создание + 2 обновления) = 0,049 * 2,1M пользователей обновляют/создают свое резюме в год => 0,00013 раз один пользователь обновляет/создает свое резюме в день| 
| __Итог__                    | 59 | |



Хранилище:

| Сущность                    | Размер (в Тб) |                                          Обоснование                                             |
|-----------------------------|---------------|--------------------------------------------------------------------------------------------------|
| Резюме                      |      11,1     | Чётких данных по распределению резюме с фото и без нет[^16]. В исследовании[^17] указывается, что из 200 резюме 27 не имеют фотографии => 86,5% пользователей имеют фотографии. Я конвертировал свою фотографию для резюме, размером в 194 Кб в формат .webp, получил картинку размером в 163 Кб, поэтому возьмём средний размер картинки за 150Кб. 1 символ весит 2 байта. Возьмём выборку из 20 резюме и посчитаем среднее количество символов: (2959 + 1341 + 5425 + 3315 + 1435 + 5141 + 951 + 3420 + 4435 + 683 + 7435 + 1009 + 2283 + 3446 + 2823 + 2442 + 2707 + 2530 + 1680 + 3558) / 20 = 2950. 2950 * 2 / 1024 = 5,8 Кб. <br>88 млн (резюме) * (5,8 Кб (текст) + 150 Кб (фото) * 0,865) = 11928400000 Кб = 11,1 Тб |
| Вакансии                    |      0,12     | Точно таким же образом рассчитаем вес текста в вакансиях, возьмем выборку из 20 вакансий. (2636 + 2033 + 2062 + 2581 + 1229 + 3215 + 3354 + 2117 + 3717 + 2113 + 3057 + 1625 + 4519 + 3262 + 1844 + 4040 + 1565 + 2020 + 2573 + 1855) / 20 = 2570. 2570 * 2 / 1024 = 5,02 Кб. Для расчета фотографий возьмем выборку из 20 вакансий. (0 + 0 + 0 + 0 + 0 + 0 + 0 + (117,6 + 0,8 + 0,7 + 0,79 + 1,03 + 1,04 + 71,2 + 108,48 + 10,08) + (37,8 + 4,5 + 324,5 + 62,03 + 0,8 + 177,9 + 88,1 + 60,9 + 50,9 + 2,6) + (117,6 + 0,8 + 0,7 + 0,79 + 1,03 + 1,04 + 71,2 + 108,48 + 10,08) + 0 + 0 + (3,2 + 10,2 + 6,6 + 6,1 + 1,06 + 0,8 + 0,8 + 296,7 + 2,3 + 9,08 + 5,9) + (87,06 + 0,18 + 0,49 + 40,6 + 6,75) + (7,7 + 12,3 + 157,01 + 1,06 + 0,44 + 0,5 + 0,76 + 0,37 + 0,46 + 0,92 + 3,17) + 0 + 0 + 0 + 0 + 0) = 2095,98. Посчитаем средний размер картинок для тех вакансий, где они есть: 2095,98 / 6 = 349,33 Кб.<br>1,217 млн (вакансии) * (5,02 Кб (текст) + 349,33 Кб (фотографии в вакансии) * 0,3 (вероятность наличия фотографий в вакансии)) = 133649723 Кб = 0,12 Тб | 
|Компании                     |      1,16     | Расчитываем вес текста и картинок, возьмем 20 случайных страниц компаний.<br>Текст: (2205 + 885 + 842 + 1497 + 585 + 1667 + 4615 + 1564 + 2568 + 992 + 2848 + 1462 + 1435 + 875 + 1177 + 1002 + 648 + 2134 + 2232 + 1959) / 20 = 1659,6. 1659,6 * 2 / 1024 = 3,2 Кб<br>Картинки: 0 + 0 + 0 + 0 + 0 + (536,3 + 98,4 + 68,7 + 65,2 + 62,5) + (0,6 + 0,57 + 0,24 + 0,61 + 0,624 + 0,43 + 0,92 + 216,18 + 154,7 + 123,9 + 0,94 + 0,486 + 0,46 + 0,98 + 0,68 + 0,57 + 1,05 + 202,9 + 155,3 + 1,04 + 131,9 + 142,52 + 243,08 + 117,5 + 227,52 + 196,77) + 0 + 0 + 0 + (1195,25 + 2,88 + 0,54 + 3,46 + 1,12 + 2,57 + 347,99 + 315,82 + 311,94 + 324,4 + 314,99 + 261,94 + 282,56 + 380,34 + 0,14 + 7,61 + 339,46 + 308,32 + 292,89 + 256,17 + 212,79 + 154,53 + 108,52 + 105,16 + 274,83 + 389,53 + 99,69 + 390,14 + 243,16) + 0 + 0 + 0 + 0 + (33,20 + 183,45 + 7,15 + 17,22 + 1,93 + 53,49 + 95,67 + 299,31 + 2,25 + 7,93 + 210,71 + 6,48) + 0 + 0 + (21,31 + 75,8 + 64,78 + 71,15 + 96,95) + 0 = 10931,09 Кб. Средний размер картинок на страницах компаний, где они есть: 10931,09 / 5 = 2186,2 Кб<br>2,276 млн (компании) * (3,2 Кб (текст) + 2186,2 Кб (фото) * 0,25) = 1251241242 Кб = 1,16 Тб | 
|Пользователи                 |       7,74       | Профили на hh.ru приватные, так что четкой информации насчет размера профиля нет. Текст будет составлять примерно 2000 символов, т.е. 3,9 Кб. Фотография так же, как и в резюме - 150 Кб.<br>54 млн (пользователи) * (3,9 Кб (текст) + 150 Кб (фото)) = 8310600000 Кб = 7,74 Тб | 

Общий размер хранилища: 26,18 Тб

### Сетевая нагрузка:

Расчет rps:
- 2,1 млн DAU * 59 (действия пользователей) / 86400 (кол-во секунд в дне) = 1434 rps
- Средний размер запроса = 5 Кб (усредненно для всех типов запросов)
- Пиковый коэффициент: 2x. Ввиду специфики сайта, нет явных пиковых событий, кроме повышенной дневной активности пользователей в сравнении с вечерней активностью.

Итого: 1434 * 5 * 2 * 8 бит = 168 Мбит/сек (средняя пиковая нагрузка)

| Действие                    | RPS | RPS в пик | Сеть пик (Мбит/сек) | Сеть в день (Гбайт/сутки) |
|-----------------------------|-----|-----------|---------------------|------------------------|
| Авторизация                 | 0,7 | 1,4 | 0,07 | 0,012 |
| Регистрация                 | 0,001 | 0,002 | 0,00000759 | 0,00004005 |
| Просмотр вакансий           | 1069 | 2138 | 3385,5 | 17853 |
| Поиск вакансий              | 316 | 632 | 1000,2 | 6274,8 |
| Публикация вакансий         | 0,02 | 0,04 | 0,042 | 0,22 |
| Закрытие вакансий           | 0,002 | 0,004 | 0,000038 | 0,0002 |
| Отклик на вакансию          | 4,8 | 9,6 | 0,15 | 0,78 |
| Ответ на отклик на вакансию | 4,8 | 9,6 | 0,076 | 0,4 |
| Использование чата          | 41,3 | 82,6 | 0,65 | 3,4 |
| Создание резюме             | 0,003 | 0,006 | 0,0067 | 0,035 |

- Авторизация
  - (0,03 * 2,1М) / 86400 = 0,7 rps
  - Несколько полей для авторизации: 100 символов * 2 = 200 байт, примерно займёт 0,2 Кб
  - 1,4 * 0,2 Кб * 8 / 1024 = 0,07 Мбит/сек
  - 0,7 * 0,2 Кб * 86400 / (1024 * 1024) = 0,012 Гбайт/сутки
- Регистрация
  - (0,00005 * 2,1М) / 86400 = 0,001 rps
  - Больше полей, чем в авторизации, примерно в 2 раза больше символов => 0,4 Кб
  - 0,002 * 0,4 Кб * 8 / 1024 = 0,00000759 Мбит/сек
  - 0,001 * 0,4 Кб * 86400 / (1024 * 1024) = 0,00004005 Гбайт/сутки
- Просмотр вакансий
  - (44 * 2,1М) / 86400 = 1069 rps
  - Поля с описанием вакансии: около 70 символов -> 0,13 Кб. Иконка: примерно 10 Кб. Страницы разбиваются на 20 карточек => 20 * 10,13 = 202,6 Кб
  - 2138 * 202,6 Кб * 8 / 1024 = 3385,5 Мбит/сек
  - 1069 * 202,6 Кб * 86400 / (1024 * 1024) = 17853 Гбайт/сутки
- Поиск вакансий
  - (13 * 2,1М) / 86400 = 316 rps
  - Размер такой же, как и в просмотре вакансий: 202,6 Кб
  - 631 * 202,6 Кб * 8 / 1024 = 1000,2 Мбит/сек
  - 316 * 202,6 Кб * 86400 / (1024 * 1024) = 6274,8 Гбайт/сутки
- Публикация вакансий
  - (0,001 * 2,1М) / 86400 = 0,02 rps
  - Размер среднестатистической вакансии был расчитан пунктом выше: 5,02 Кб (текст) + 349,33 Кб (фотографии в вакансии) * 0,3 = 109,8 Кб
  - 0,04 * 109,8 Кб * 8 / 1024 = 0,042 Мбит/сек
  - 0,02 * 109,8 Кб * 86400 / (1024 * 1024) = 0,22 Гбайт/сутки
- Закрытие вакансий
  - (0,0001 * 2,1М) / 86400 = 0,002 rps
  - Служебная информация, не более 1 Кб
  - 0,004 * 1 Кб * 8 / 1024 = 0,000038 Мбит/сек
  - 0,002 * 1 Кб * 86400 / (1024 * 1024) = 0,0002 Гбайт/сутки
- Отклик на вакансию
  - (0,2 * 2,1М) / 86400 = 4,8 rps
  - сопросодитльное письмо - не более 1000 символов -> 1,95 Кб
  - 9,6 * 1,95 Кб * 8 / 1024 = 0,15 Мбит/сек
  - 4,8 * 1,95 Кб * 86400 / (1024 * 1024) = 0,78 Гбайт/сутки
- Ответ на отклик на вакансию
  - (0,2 * 2,1М) / 86400 = 4,8 rps
  - Текст ответа - не более 500 символов -> 1 Кб
  - 9,6 * 1 Кб * 8 / 1024 = 0,076 Мбит/сек
  - 4,8 * 1 Кб * 86400 / (1024 * 1024) = 0,4 Гбайт/сутки
- Использование чата
  - (1,7 * 2,1М) / 86400 = 41,3 rps
  - 1 Кб - текст сообщения (как в отклике на вакансию, используется тот же самый чат)
  - 82,6 * 1 Кб * 8 / 1024 = 0,65 Мбит/сек
  - 41,3 * 1 Кб * 86400 / (1024 * 1024) = 3,4 Гбайт/сутки
- Создание резюме
  - (0,00013 * 2,1М) / 86400 = 0,003 rps
  - Размер резюме рассчитывался в прошлом пункте: 5,8 Кб (текст) + 150 Кб (фото) * 0,865 = 135,5 Кб
  - 0,006 * 135,5 Кб * 8 / 1024 = 0,0067 Мбит/сек
  - 0,003 * 135,5 Кб * 86400 / (1024 * 1024) = 0,035 Гбайт/сутки
 


## 3. Глобальная балансировка

Распределение по странам [^2]:
1. Россия - 91,96%
2. Беларусь - 2,13%
3. Германия - 0,82%
4. Армения - 0,56%
5. Нидерланды - 0,55%

![Сетевые магистрали в России](https://www.comnews.ru/sites/default/files2019/reviews/2021-12/flatmapmagistr2021.png)

На основе данных о распределении трафика по территориям расположим датацентры:

<img width="1367" height="726" alt="network_datacentres" src="https://github.com/user-attachments/assets/ddb06b1d-7d9a-44a8-800d-b75fe72d799b" />


- Москва (3 ДЦ)
  - 92% трафика исходит из России. В Москве сосредоточены крупнейшие российские IX и точки взаимодействия, и через них проходит основная внутрироссийская и международная маршрутизация; оттуда проще обеспечивать низкий RTT и много путей к операторам.[^20] Из источника[^21] можно увидеть, что до Владивостока задержка составляет примерно 100-150 мс, что является приемлеой задержкой, поэтому располагаем 3 ДЦ в Москве
 


Будем использовать anycast, чтобы при выходе из строя одного из датацентров сразу было переключение на другой.


| Действие             | Сеть пик (Мбит/сек)        | **Москва ДЦ 1 (33%)**  | **Москва ДЦ 2 (33%)**  |  **Москва ДЦ 3 (33%)** |
|----------------------|------------------|------------------------|------------------------|------------------------|
| Авторизация                 | 0,07 | 0,0231 | 0,0231 | 0,0231 |
| Регистрация                 | 0,00000759 | 0,0000025 | 0,0000025 | 0,0000025 |
| Просмотр вакансий           | 3385,5 | 1117,215 | 1117,215 | 1117,215 |
| Поиск вакансий              | 1000,2 | 330,066 | 330,066 | 330,066 |
| Публикация вакансий         | 0,042 | 0,01386 | 0,01386 | 0,01386 |
| Закрытие вакансий           | 0,000038 | 0,00001254 | 0,00001254 | 0,00001254 |
| Отклик на вакансию          | 0,15 | 0,0495 | 0,0495 | 0,0495 |
| Ответ на отклик на вакансию | 0,076 | 0,02508 | 0,02508 | 0,02508 |
| Использование чата          | 0,65 | 0,2145 | 0,2145 | 0,2145 |
| Создание резюме             | 0,0067 | 0,002211 | 0,002211 | 0,002211 |
| **Итого (Сеть пик)** | **~4386,7 Мбит/сек**  | **1447,61 Мбит/сек**          | **1447,61 Мбит/сек**          | **1447,61 Мбит/сек** |


| Действие             | RPS пик | **Москва ДЦ 1 (33%)**  | **Москва ДЦ 2 (33%)**  | **Москва ДЦ 3 (33%)**  |
|----------------------|---------|------------------------|------------------------|------------------------|
| Авторизация                 | 1,4 | 0,462 | 0,462 | 0,462 |
| Регистрация                 | 0,002 | 0,00066 | 0,00066 | 0,00066 |
| Просмотр вакансий           | 2138 | 705,54 | 705,54 | 705,54 |
| Поиск вакансий              | 632 | 208,56 | 208,56 | 208,56 |
| Публикация вакансий         | 0,02 | 0,04 | 0,042 | 0,22 |
| Закрытие вакансий           | 0,004 | 0,0132 | 0,0132 | 0,0132 |
| Отклик на вакансию          | 9,6 | 3,168 | 3,168 | 3,168 |
| Ответ на отклик на вакансию | 9,6 | 3,168 | 3,168 | 3,168 |
| Использование чата          | 82,6 | 27,258 | 27,258 | 27,258 |
| Создание резюме             | 0,006 | 0,00198 | 0,00198 | 0,00198 |
| **Итого (RPS пик)**  | **2873,23** | **948,17**            | **948,17**            | **948,17**           |


 ## 4. Локальная балансировка

Используем Nginx для проксирования запросов внутри ДЦ. Для оркестрации контейнеров будем исользовать K8s, который гарантирует отказоустойчивость правильной манипуляцией контейнерами. В принципе, Nginx и K8s - частая практика в высоконагруженных системах.


- L7 балансировка. Используем HTTP Reverse proxy (Nginx Ingress Controller). Реализовывает SSL Termination, чтобы внутренние сервисы работали по http, а не https, т.е. https запрос расшифровывается на L7 прокси. Также может хранить часто запрашиваемый контент и тем самым ускоряет отклик. Будем использовать 2N балансировщиков, т.е. 2 балансировщика, 1 основной и 1 резервирующий. Также нужен отдельный сервис keepalived для мониторинга жизни. Через протокол VRRP при отказе осноного балансировщика трафик будет идти на резервирующий. Используем балансировку round robin


## 5. Логическая схема БД

<img width="1347" height="689" alt="image" src="https://github.com/user-attachments/assets/1ff332b4-4042-40d2-98b1-226a8709b255" />




### Описание таблиц
| Таблица                | Назначение                                                                                                                                           |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| **users**              | Хранит данные всех пользователей системы: кандидатов, рекрутеров и администраторов. Содержит учётные данные, роли и основную информацию профиля.     |
| **companies**          | Содержит сведения о компаниях-работодателях: название, описание, сайт, логотип и местоположение.                                                     |
| **company_recruiters** | Связующая таблица между компаниями и рекрутерами (отношение многие-ко-многим). Определяет, какие пользователи управляют вакансиями конкретной компании. |
| **vacancies**          | Хранит данные о вакансиях, опубликованных рекрутерами от имени компаний: название, описание, категория, локация и статус активности.                 |
| **resumes**            | Содержит резюме кандидатов, включая общую информацию и краткое описание опыта.                                                                       |
| **resume_skills**      | Хранит навыки и уровень мастерства этого навыка в резюме                                              |
| **applications**       | Представляет отклики кандидатов на вакансии. Содержит ссылки на вакансию, кандидата и резюме, статус отклика и флаги от LLM-модели (спам/не спам).   |
| **messages**           | Содержит сообщения внутреннего чата между кандидатом и рекрутером, связанные с конкретным откликом.                                                  |



### Требования к консистентности

- Пользователи (users)
  - При удалении удаляются связанные резюме, отклики, сообщения, вакансии и связи с компаниями.
  - Email уникален.

- Компании (companies)
  - При удалении каскадно удаляются связи с рекрутерами и вакансии.
  - Удаление запрещено при активных вакансиях.
  - Название компании уникально.

- Связка рекрутеров и компаний (company_recruiters)
  - При удалении компании или пользователя связь удаляется.
  - Один рекрутер не может быть дважды привязан к одной компании.

- Вакансии (vacancies)
  - При удалении каскадно удаляются отклики и сообщения.
  - Нельзя создать вакансию без компании и рекрутера.
  - Удаление запрещено при активных откликах.

- Резюме (resumes)
  - При удалении удаляются связанные навыки и отклики.
  - Удаление запрещено, если резюме участвует в активных откликах.

- Навыки (resume_skills)
  - При удалении резюме навыки удаляются.
  - Навык не может дублироваться в рамках одного резюме.

- Отклики (applications)
  - При удалении вакансии или резюме отклики удаляются.
  - Один кандидат не может откликнуться на вакансию дважды.





## Ссылки

[^1]: https://yadro.ru/stat/HeadHunter/index.html?period=month
[^2]: https://hypestat.com/info/hh.ru
[^3]: https://investor.hh.ru/
[^4]: https://hh.ru/article/28?from=footer_new&hhtmFromLabel=footer_new&hhtmFrom=main
[^5]: https://hh.ru/search/resume?text=&area=1&isDefaultArea=true&exp_period=all_time&logic=normal&pos=full_text&hhtmFrom=vacancy_search_list&hhtmFromLabel=resume_search_line
[^6]: https://www.indeed.com/about
[^7]: https://hypestat.com/info/indeed.com
[^8]: https://analyzify.com/statsup/linkedin
[^9]: https://thesocialshepherd.com/blog/linkedin-statistics
[^10]: https://news.linkedin.com/about-us 
[^11]: https://hypestat.com/info/linkedin.com
[^12]: https://searchanise.io/blog/navigation-vs-search-box/
[^13]: https://www.businessofapps.com/data/linkedin-statistics/
[^14]: https://stats.hh.ru/moscow
[^15]: https://supplygem.com/publications/linkedin-statistics
[^16]: https://hh.ru/search/resume?from=employer_index_footer&page=2&searchSessionId=c80868f7-3b88-4f5d-b43b-d229e60acb33
[^17]: https://careersdonewrite.com/blog/photo-study-a-survey-of-linkedin-profiles/?utm_source=chatgpt.com
[^18]: https://portraitpal.ai/blog/what-size-should-a-headshot-be/
[^19]: https://resume.co/blog/update-resume
[^20]: https://www.msk-ix.ru/
[^21]: https://ruvds.com/ru-rub#advantages
